<div class="form-container">
  <div class="form-header">
    <h2>
      <%= curriculum.new_record? ? "Registrar Currículum" : "Editar Currículum" %>
    </h2>
  </div>

  <% if curriculum.errors.any? %>
    <div class="alert alert-danger">
      <h3 style="margin-top: 0;">Errores encontrados:</h3>
      <ul style="margin: 10px 0; padding-left: 20px;">
          <% curriculum.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
      </ul>
    </div>
  <% end %>

  <%= form_with(model: curriculum, local: true) do |form| %>
    <fieldset>
      <legend>Datos Personales</legend>

      <!-- Nombre -->
      <div class="form-group">
        <%= form.label :first_name, "Nombre(s)" %>
        <%= form.text_field :first_name, placeholder: "Ej: Juan", style: "width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" %>
      </div>

      <!-- Apellido -->
      <div class="form-group">
        <%= form.label :last_name, "Apellidos" %>
        <%= form.text_field :last_name, placeholder: "Ej: Pérez García", style: "width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" %>
      </div>

      <!-- Fecha de Nacimiento -->
      <div class="form-group">
        <%= form.label :birth_date, "Fecha de Nacimiento (debes ser mayor de 18 años)" %>
        <%= form.date_field :birth_date, style: "width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" %>
      </div>

      <!-- Identificación -->
      <div class="form-group">
        <%= form.label :identification, "Número de Identificación" %>
        <%= form.text_field :identification, placeholder: "Ej: 1234567890", style: "width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" %>
      </div>

      <!-- Teléfono -->
      <div class="form-group">
        <%= form.label :phone_number, "Teléfono" %>
        <%= form.text_field :phone_number, placeholder: "Ej: +57 300 1234567", style: "width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" %>
      </div>

      <!-- Dirección -->
      <div class="form-group">
        <%= form.label :address, "Dirección de Residencia" %>
        <%= form.text_field :address, placeholder: "Ej: Carrera 5", style: "width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" %>
      </div>

      <!-- Ciudad -->
      <div class="form-group">
        <%= form.label :city, "Ciudad" %>
        <%= form.text_field :city, placeholder: "Ej: Bogotá", style: "width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" %>
      </div>

      <!-- Departamento -->
      <div class="form-group">
        <%= form.label :department, "Departamento/Región" %>
        <%= form.text_field :department, placeholder: "Ej: Cundinamarca", style: "width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" %>
      </div>

      <!-- País -->
      <div class="form-group">
        <%= form.label :country, "País" %>
        <%= form.text_field :country, style: "width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" %>
      </div>

      <!-- Foto de Perfil -->
      <div class="form-group">
        <%= form.label :photo, "Foto de Perfil (JPEG o PNG, máximo 2 MB)" %>
        <%= form.file_field :photo, accept: "image/jpeg,image/png", style: "width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" %>
        <% if curriculum.photo.attached? %>
          <div class="current-photo">
            <img src="<%= url_for(curriculum.photo) %>" alt="Foto de perfil" class="photo-preview-img">
            <p>Foto actual</p>
          </div>
        <% end %>
      </div>

      <!-- Perfil/Descripción Personal -->
      <div class="form-group">
        <%= form.label :profile_description, "Perfil o Descripción Personal" %>
        <%= form.text_area :profile_description, placeholder: "Describe tu perfil profesional...", rows: 5, style: "width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" %>
        <small>Máximo 2000 caracteres</small>
      </div>

      <!-- Disponibilidad para Viajar -->
      <div class="form-group">
        <%= form.label :available_to_travel, "¿Disponibilidad para Viajar?" %>
        <div class="radio-group">
          <%= form.radio_button :available_to_travel, true %>
          <%= form.label :available_to_travel_true, "Sí" %>
          <%= form.radio_button :available_to_travel, false %>
          <%= form.label :available_to_travel_false, "No" %>
        </div>
      </div>

      <!-- Disponibilidad para Cambio de Residencia -->
      <div class="form-group">
        <%= form.label :available_to_relocate, "¿Disponibilidad para Cambio de Residencia?" %>
        <div class="radio-group">
          <%= form.radio_button :available_to_relocate, true %>
          <%= form.label :available_to_relocate_true, "Sí" %>
          <%= form.radio_button :available_to_relocate, false %>
          <%= form.label :available_to_relocate_false, "No" %>
        </div>
      </div>

      <!-- Idiomas -->
      <div class="form-group">
        <%= form.label :languages, "Idiomas" %>
        <div class="checkbox-container">
          <div class="checkbox-item">
            <label>
              <input type="checkbox" name="curriculum[languages][]" value="Español" <% if (curriculum.languages || []).include?('Español') %>checked<% end %>>
              Español
            </label>
          </div>
          <div class="checkbox-item">
            <label>
              <input type="checkbox" name="curriculum[languages][]" value="Inglés" <% if (curriculum.languages || []).include?('Inglés') %>checked<% end %>>
              Inglés
            </label>
          </div>
          <div class="other-languages-section">
            <p style="margin: 0 0 8px 0; font-weight: 500; font-size: 14px;">Otros idiomas:</p>
            <div id="other-languages-container">
              <% (curriculum.languages || []).reject { |lang| ['Español', 'Inglés'].include?(lang) }.each do |lang| %>
                <div class="language-item">
                  <span><%= lang %></span>
                  <button type="button" class="remove-other-language" data-language="<%= lang %>" class="btn-remove">×</button>
                </div>
              <% end %>
            </div>
            <div class="language-input-group">
              <input type="text" id="new-other-language" placeholder="Ej: Portugués, Francés, etc." class="language-input">
              <button type="button" id="add-other-language-btn" class="btn btn-primary btn-sm">Agregar</button>
            </div>
            <input type="hidden" id="other-languages-hidden" name="curriculum[other_languages]" value="<% (curriculum.languages || []).reject { |lang| ['Español', 'Inglés'].include?(lang) }.join(',') %>">
          </div>
          <input type="hidden" name="curriculum[languages][]" value="">
        </div>
      </div>

      <!-- Información Académica -->
      <div class="academic-section">
        <h3>Información Académica</h3>
        
        <div id="studies-container">
          <%= form.fields_for :studies do |study_form| %>
            <div class="study-panel study-fields">
              <div class="study-header">
                <h4>Estudio</h4>
                <%= study_form.check_box :_destroy, style: "display: none;" %>
                <button type="button" class="remove-study-btn" class="btn btn-danger btn-sm">Eliminar</button>
              </div>

              <div class="form-group">
                <%= study_form.label :institution, "Institución *", style: "display: block; margin-bottom: 5px; font-size: 14px; font-weight: 500;" %>
                <%= study_form.text_field :institution, style: "width: 100%; max-width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box;" %>
              </div>

              <div class="form-group">
                <%= study_form.label :status, "Estado", style: "display: block; margin-bottom: 5px; font-size: 14px; font-weight: 500;" %>
                <%= study_form.select :status, [['Cursando', 'cursando'], ['Pausado', 'pausado'], ['Finalizado', 'finalizado']], { include_blank: 'Seleccionar' }, style: "width: 100%; max-width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box;" %>
              </div>

              <div class="form-grid-2">
                <div>
                  <%= study_form.label :start_date, "Fecha Inicio", style: "display: block; margin-bottom: 5px; font-size: 14px; font-weight: 500;" %>
                  <%= study_form.date_field :start_date, style: "width: 100%; max-width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box;" %>
                </div>
                <div>
                  <%= study_form.label :end_date, "Fecha Fin", style: "display: block; margin-bottom: 5px; font-size: 14px; font-weight: 500;" %>
                  <%= study_form.date_field :end_date, style: "width: 100%; max-width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box;" %>
                </div>
              </div>

              <div class="form-group" style="margin-bottom: 0;">
                <%= study_form.label :title, "Título", style: "display: block; margin-bottom: 5px; font-size: 14px; font-weight: 500;" %>
                <%= study_form.text_field :title, style: "width: 100%; max-width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box;" %>
              </div>
            </div>
          <% end %>
        </div>

        <button type="button" id="add-study-btn" class="btn btn-primary btn-sm">+ Agregar Estudio</button>
      </div>
    </fieldset>

    <!-- Botones de acción -->
    <div class="form-actions">
      <% submit_text = curriculum.new_record? ? "Registrar Currículum" : "Actualizar Currículum" %>
      <button type="submit" class="btn btn-success btn-full"><%= submit_text %></button>
      <%= link_to "Cancelar", root_path, style: "flex: 1; padding: 10px; background-color: #6c757d; color: white; text-decoration: none; border-radius: 4px; text-align: center;" %>
    </div>
  <% end %>
</div>

<script>
document.getElementById('add-other-language-btn').addEventListener('click', function(e) {
  e.preventDefault();
  const input = document.getElementById('new-other-language');
  const language = input.value.trim();
  
  if (!language) {
    alert('Por favor ingresa un idioma');
    return;
  }
  
  const container = document.getElementById('other-languages-container');
  const div = document.createElement('div');
  div.className = 'language-item';
  
  const span = document.createElement('span');
  span.textContent = language;
  
  const btn = document.createElement('button');
  btn.type = 'button';
  btn.className = 'remove-other-language';
  btn.dataset.language = language;
  btn.textContent = '×';
  btn.className = 'btn-remove';
  
  btn.addEventListener('click', function(e) {
    e.preventDefault();
    div.remove();
    updateOtherLanguagesHidden();
  });
  
  div.appendChild(span);
  div.appendChild(btn);
  container.appendChild(div);
  
  updateOtherLanguagesHidden();
  input.value = '';
});

document.getElementById('new-other-language').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    document.getElementById('add-other-language-btn').click();
  }
});

document.addEventListener('click', function(e) {
  if (e.target.classList.contains('remove-other-language') && e.target.tagName === 'BUTTON') {
    e.preventDefault();
    e.target.parentElement.remove();
    updateOtherLanguagesHidden();
  }
});

function updateOtherLanguagesHidden() {
  const languages = Array.from(document.querySelectorAll('.remove-other-language')).map(btn => btn.dataset.language);
  document.getElementById('other-languages-hidden').value = languages.join(',');
}

// Funcionalidad para agregar/eliminar estudios dinámicamente
let studyIndex = <%= curriculum.studies.size %>;

document.getElementById('add-study-btn').addEventListener('click', function(e) {
  e.preventDefault();
  
  const container = document.getElementById('studies-container');
  const newStudy = document.createElement('div');
  newStudy.className = 'study-fields';
  newStudy.className = 'study-panel study-fields';
  
newStudy.innerHTML = `
  <div class="study-header">
    <h4>Estudio</h4>
    <button type="button" class="remove-study-btn btn btn-danger btn-sm">Eliminar</button>
  </div>

  <div class="form-group">
    <label for="curriculum_studies_attributes_${studyIndex}_institution">Institución *</label>
    <input type="text" name="curriculum[studies_attributes][${studyIndex}][institution]" id="curriculum_studies_attributes_${studyIndex}_institution" class="form-control">
  </div>

  <div class="form-group">
    <label for="curriculum_studies_attributes_${studyIndex}_status">Estado</label>
    <select name="curriculum[studies_attributes][${studyIndex}][status]" id="curriculum_studies_attributes_${studyIndex}_status" class="form-control">
      <option value="">Seleccionar</option>
      <option value="cursando">Cursando</option>
      <option value="pausado">Pausado</option>
      <option value="finalizado">Finalizado</option>
    </select>
  </div>

  <div class="form-grid-2">
    <div>
      <label for="curriculum_studies_attributes_${studyIndex}_start_date">Fecha Inicio</label>
      <input type="date" name="curriculum[studies_attributes][${studyIndex}][start_date]" id="curriculum_studies_attributes_${studyIndex}_start_date" class="form-control">
    </div>
    <div>
      <label for="curriculum_studies_attributes_${studyIndex}_end_date">Fecha Fin</label>
      <input type="date" name="curriculum[studies_attributes][${studyIndex}][end_date]" id="curriculum_studies_attributes_${studyIndex}_end_date" class="form-control">
    </div>
  </div>

  <div class="form-group" style="margin-bottom: 0;">
    <label for="curriculum_studies_attributes_${studyIndex}_title">Título</label>
    <input type="text" name="curriculum[studies_attributes][${studyIndex}][title]" id="curriculum_studies_attributes_${studyIndex}_title" class="form-control">
  </div>
`;
  
  container.appendChild(newStudy);
  studyIndex++;
});

// Event delegation para eliminar estudios
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('remove-study-btn')) {
    e.preventDefault();
    const studyField = e.target.closest('.study-fields');
    
    // Si tiene un checkbox _destroy, marcarlo
    const destroyCheckbox = studyField.querySelector('input[type="checkbox"][name*="_destroy"]');
    if (destroyCheckbox) {
      destroyCheckbox.checked = true;
      studyField.style.display = 'none';
    } else {
      // Si es nuevo (sin ID), simplemente eliminarlo del DOM
      studyField.remove();
    }
  }
});
</script>
